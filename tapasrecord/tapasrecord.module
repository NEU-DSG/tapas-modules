<?php

define("TAPAS_VALIDATION_XSLT_SUBDIRECTORY", "/validate/");
define("TAPAS_SAVE_FILE_ROOT_DIRECTORY", "public://tapasrecord");
define("TAPAS_TFC_TRANSFORM_FILENAME", "transform/tfc_transform.xsl");

define("TAPAS_ERROR_KNOWN_FILE_ERROR", 
	t("We found problems with the tei file which prevent us from being able " .
	"to load it. Please double-check the file, or contact us with any questions."));

define("TAPAS_ERROR_UNSUPPORTED_ERROR", 
	t("We were unable to process the tei file. This may be due to a problem in " .
	"the file, or it may be that while the tei is valid, we are not yet equipped to deal with all the elements. If " .
	"you are confident your file is valid, please open a support ticket, to allow us to improve our system."));

define("TAPAS_ERROR_OUR_END", 
	t("There appears to be an error at our end. Please open a support ticket, " .
	"copy-and-pasting all error messages, and we'll fix it as soon as possible."));

define("TAPAS_ERROR_UNKNOWN", 
	t("An unknown error occured. If you are confident that the tei file you are " .
	"uploading is valid, please open a support ticket so that we can figure out what happened."));

// TODO: Use private file system rather than public
// TODO: Make TEI field mandatory for new (NOT updated) TAPAS Record nodes
// TODO: REmove the TFC field, since we don't need that to be a field.
// TODO: Handle TEI upload name collisions
// TODO: When there is a failed upload attempt, clear out errors from screen before next
//       upload attempt, to prevent confusion.
// TODO: Fix XML-prefix error warning to say this on it's own won't prevent upload
// TODO: Change known errors that DO prevent upload from warnings back into errors.

/**
 * @file
 * tapasrecord.module TAPAS TEI upload and transformation
 * 
 * defines tapas_record conent type, performs
 * TEI upload and validation, calls TFC transform.
 */

/**
 * implements hook_node_info()
 *
 * Defines the TAPAS record content type
 *
 * I considered making this an entity rather than a node, since node brings
 * along extra baggage that we don't need. However, Drupal's access-control
 * system is node-based; therefore, it would be far more difficult to enforce
 * access restrictions on a custom entity than on a custom node type.
 */

function tapasrecord_node_info()
{
  return array(
    'tapasrecordnode' => array(
      'name' => t('TAPAS Record'),
      'base' => 'tapasrecordnode',
      'description' => t('Holds a TEI record along with it\'s associated metadata and TFC'),
      'has_title' => TRUE,
      'title_label' => t('Record Title'),
      'help' => '',
    ),
  );
}

/** 
 * implements hook_form()
 * 
 * This has to be present even if it's just a pass-through,
 * otherwise the content type won't appear in the 
 * admin/structure/types list 
 */
function tapasrecordnode_form($node, $form_state) {
  return node_content_form($node, $form_state);
}

/** 
 * Implements hook_form_FORM_ID_alter().
 */
function tapasrecord_form_tapasrecordnode_node_form_alter(&$form, &$form_state, $form_id) {

	// TAPAS TEI field
	$form['tapas_teifield'][LANGUAGE_NONE][0] = array_merge(
    $form['tapas_teifield'][LANGUAGE_NONE][0],
		_tapasrecord_form_teifield($form_id)
	);

}

function _tapasrecord_form_teifield($form_id) {
	return array(
		'#type' => 'managed_file',
		'#title' => t('TEI file'),
		'#description' => t('allowed extentions: .tei, .xml'),
		'#upload_location' => _tapasrecord_get_file_upload_location(),
		'#upload_validators' => array(
			'file_validate_extensions' => array('tei xml'),
			'tapasrecord_validate_tei' => array($form_id),
		),
  );

}

function _tapasrecord_get_file_upload_location() {
	// TODO: Project level files will be root/<project slug>
	// TODO: Record level files will be root/<record persistant id>
	// TODO: directory_prepare function to set permissions, & create directory
	//       if it doesn't alreay exist.
	return TAPAS_SAVE_FILE_ROOT_DIRECTORY;
}



/**
 * Callback to run the validation XSLT checks on the TEI file.
 */
function tapasrecord_validate_tei($file, $form_id) {

	module_load_include('inc', 'tapasrecord', 'tapasrecord.xmlproc');
	$errors = array();

	$teiDOM = tapasrecord_domdoc_load($file->uri, $errors);
	if ($errors) {
		return $errors;
	}


	$errors = _tapasrecord_validate_xslt($teiDOM);
	if ($errors) {
		return $errors;
	}

	//drupal_set_message(_tapasrecord_extract_tei_metadata($teiDOM));
	//$errors = _tapasrecord_extract_tei_metadata($teiDOM);
	//if ($errors) {
	//  foreach ($errors as $e) {
	//    drupal_set_message($e, 'warning');
	//  }
	//  drupal_set_message(t("There were problems trying to extract metadata from this TEI file."), 'warning');
	//}

	return _tapasrecord_run_transform($teiDOM, $file);
}


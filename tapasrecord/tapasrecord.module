<?php

/**
 * @file
 * tapasrecord.module TAPAS TEI upload and transformation
 * 
 * defines tapas_record conent type, performs
 * TEI upload and validation, calls TFC transform.
 */


// ====================================================================================
// Functions Implementing Hooks
// ====================================================================================

/**
 * implements hook_node_info()
 *
 * Defines the TAPAS record content type
 *
 * I considered making this an entity rather than a node, since node brings
 * along extra baggage that we don't need. However, Drupal's access-control
 * system is node-based; therefore, it would be far more difficult to enforce
 * access restrictions on a custom entity than on a custom node type.
 */

function tapasrecord_node_info()
{
  return array(
    'tapasrecordnode' => array(
      'name' => t('TAPAS Record'),
      'base' => 'tapasrecordnode',
      'description' => t('Holds a TEI record along with it\'s associated metadata and TFC'),
      'has_title' => TRUE,
      'title_label' => t('Record Title'),
      'help' => '',
    ),
  );
}

/** 
 * implements hook_form()
 * 
 * This has to be present even if it's just a pass-through,
 * otherwise the content type won't appear in the 
 * admin/structure/types list 
 */
function tapasrecordnode_form($node, $form_state) {
  return node_content_form($node, $form_state);
}


/**
 * implements hook_node_insert().
 */

function tapasrecordnode_node_insert($node) {
/*On CREATE of a new TEI document, the following fields are required: collection_dids, tei, depositor, and file_types.*/

//On UPDATE no fields are required and the following fields are forbidden: depositor.

//The http fields that this endpoint expects are:

//collection_dids : An array of Drupal IDs that this CoreFile should be associated with. To update this, pass in a new array that will entirely replace the previous collection relationships.
//tei : The literal TEI file associated with this record. Reading interface versions of this file will be generated.
//display_author : A sanitized version of the principle author of this document's name.
//display_contributors : An array listing sanitized contributor names.
//display_date : A date. For any TEI record there are several dates associated with it that may be considered significant, but for our 1.0 launch we're just asking for a single date that will be used everywhere. Must be in the ISO-8601 format.
/*support_files : A .zip file containing all of the files associated with this TEI record. When support file updates are required, every support file still attached to this TEI record must be sent in this zip; preexisting support type files are purged before adding new ones. Currently the only supported files are page images that are embedded in the TEI document and the thumbnail associated with this record. The expected zip file structure is this:*/

	$uid = "TEI" . $node->uid;


	$data = array(
		'collection_dids' => '',
		'depositor' => '',
		'file_types' => '',
		'display_author' => '',
		'display_contributors' => '',
		'display_date' => '', // I thought we weren't sending this to Hydra?
	);

	$files = array(
		'tei:'=> '',
		'support_files' => '',
	);


	$uid = "TEI" . $node->$uid;
	// Generate Data array.
	// Generate Files array.
	// Make the Hydra API call. 
}


/**
 * implements hook_node_update().
 */

function tapasrecordnode_node_update($node) {


}

/**
 * implements hook_node_delete().
 */

function tapasrecordnode_node_delete($node) {


}


// ====================================================================================
// Helper Functions
// ====================================================================================

// ==========================================================
// Old functions, probably to remove.
// ==========================================================
/** 
 * Implements hook_form_FORM_ID_alter().
 */
function tapasrecord_form_tapasrecordnode_node_form_alter(&$form, &$form_state, $form_id) {

	// TAPAS TEI field
	$form['tapas_teifield'][LANGUAGE_NONE][0] = array_merge(
    $form['tapas_teifield'][LANGUAGE_NONE][0],
		_tapasrecord_form_teifield($form_id)
	);

}

function _tapasrecord_form_teifield($form_id) {
	return array(
		'#type' => 'managed_file',
		'#title' => t('TEI file'),
		'#description' => t('allowed extentions: .tei, .xml'),
		'#upload_location' => _tapasrecord_get_file_upload_location(),
		'#upload_validators' => array(
			'file_validate_extensions' => array('tei xml'),
			'tapasrecord_validate_tei' => array($form_id),
		),
  );

}

function _tapasrecord_get_file_upload_location() {
	// TODO: Project level files will be root/<project slug>
	// TODO: Record level files will be root/<record persistant id>
	// TODO: directory_prepare function to set permissions, & create directory
	//       if it doesn't alreay exist.
	return TAPAS_SAVE_FILE_ROOT_DIRECTORY;
}



/**
 * Callback to run the validation XSLT checks on the TEI file.
 */
function tapasrecord_validate_tei($file, $form_id) {

	module_load_include('inc', 'tapasrecord', 'tapasrecord.xmlproc');
	$errors = array();

	$teiDOM = tapasrecord_domdoc_load($file->uri, $errors);
	if ($errors) {
		return $errors;
	}


	$errors = _tapasrecord_validate_xslt($teiDOM);
	if ($errors) {
		return $errors;
	}

	//drupal_set_message(_tapasrecord_extract_tei_metadata($teiDOM));
	//$errors = _tapasrecord_extract_tei_metadata($teiDOM);
	//if ($errors) {
	//  foreach ($errors as $e) {
	//    drupal_set_message($e, 'warning');
	//  }
	//  drupal_set_message(t("There were problems trying to extract metadata from this TEI file."), 'warning');
	//}

	return _tapasrecord_run_transform($teiDOM, $file);
}

